{% extends "base.html" %}

{% block title %}
    <title>채팅: 철거해조</title>
{% endblock %}

{% load static %}
{% block sytle %}
    <link rel="stylesheet" href="{% static 'chat/style.css' %}" type="text/css" />
{% endblock %}
 
{% block content %}  

        <section id="chatting">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="chat_wrap">
                            <div class="header">
                            {% if user_extend.user_type == 'R' %}
                                {{ chat_room.ptr.user_extend.biz_nm }}
                            {% elif user_extend.user_type == 'P' %}
                                {{ chat_room.reqr.user_extend.nickname }}
                            {% endif %}
                            </div>
                            
                            {% if chat_messages %}
                            <div class="chat">
                                
                                <!-- 동적 생성 -->
                                <!-- 메시지 한 칸 format -->
                                <div class="chat format">
                                    <ul>
                                        <li>
                                            <div class="sender"> 
                                                <span>sender</span>
                                            </div>
                                            <div class="message">
                                                <span>message</span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="chat format">
                                    <ul>
                                        <li>
                                            <div class="sender"> 
                                                <span>sender</span>
                                            </div>
                                            <div class="message">
                                                <span>message</span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>


                                
                            </div>
                            {% else %}
                            <div class="chat">
                            </div>

                            <div class="input-div">
                                <textarea placeholder="Press Enter for send message."></textarea>
                            </div>
                        
                            
                        </div>
                    </div>
                </div>        
            </div>
        </section>

        <section id="send_message">
            <div class="form-group">
            {% if user_extend.user_type == 'R' %} 
                <form method="POST" action="{% url 'chat:send_message' user_extend.user.id chat_room.ptr.id  %}" id="send_message">
                    {% csrf_token %}
                    <div class="inline">
                        <textarea class="form-control" id="message" rows="3" name="message" placeholder="Write.." ></textarea>
                        <input class="btn btn-secondary send" type="button"  value="Send"><br>
                    </div>
                </form>

            {% elif user_extend.user_type == 'P' %}
                <form method="POST" action="{% url 'chat:send_message' chat_room.reqr.id user_extend.user.id  %}" id="send_message">
                    {% csrf_token %}
                    <div class="inline">
                        <textarea class="form-control" id="message" rows="3" name="message" placeholder="Write.." ></textarea>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form> 
            {% endif %}
            </div>   
        </section>



<script>
    const Chat = (function(){
        const myName = "blue"; //보낸사람
    
        // init 함수
        function init() {
            // enter 키 이벤트
            $(document).on('keydown', 'div.input-div textarea', function(e){
                if(e.keyCode == 13 && !e.shiftKey) {
                    e.preventDefault();
                    const message = $(this).val();
    
                    // 메시지 전송
                    sendMessage(message);
                    // 입력창 clear
                    clearTextarea();
                }
            });
        }
    
        // 메세지 태그 생성
        function createMessageTag(LR_className, senderName, message) {
            // 형식 가져오기
            let chatLi = $('div.chat.format ul li').clone();
    
            // 값 채우기
            chatLi.addClass(LR_className);
            chatLi.find('.sender span').text(senderName);
            chatLi.find('.message span').text(message);
    
            return chatLi;
        }
    
        // 메세지 태그 append
        function appendMessageTag(LR_className, senderName, message) {
            const chatLi = createMessageTag(LR_className, senderName, message);
    
            $('div.chat:not(.format) ul').append(chatLi);
    
            // 스크롤바 아래 고정
            $('div.chat').scrollTop($('div.chat').prop('scrollHeight'));
        }
    
        // 메세지 전송
        function sendMessage(message) {
            // 서버에 전송하는 코드로 후에 대체
            const data = {
                "senderName"    : "blue",
                "message"        : message
            };
    
            // 통신하는 기능이 없으므로 여기서 receive
            resive(data);
        }
    
        // 메세지 입력박스 내용 지우기
        function clearTextarea() {
            $('div.input-div textarea').val('');
        }
    
        // 메세지 수신
        function resive(data) {
            const LR = (data.senderName != myName)? "left" : "right";
            appendMessageTag("right", data.senderName, data.message);
        }
    
        return {
            'init': init
        };
    })();
    
    $(function(){
        Chat.init();
    });
</script>


{% endblock %}